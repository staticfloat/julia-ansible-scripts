---
- hosts: julia_buildslaves_ancient
  gather_facts: no
  sudo: yes
  tasks:
    # Bootstrap legacy python 2.4 hosts
    - raw: yum -y install python-simplejson


- hosts: julia_buildslaves_ancient
  sudo: yes
  roles:
    - repo-epel


# Download/install GCC on ancient buildslaves
- hosts: julia_buildslaves_ancient
  sudo: no
  tasks:
    # Download GCC, get source all setup and ready to build
    - file: path=~/src state=directory
    - file: path=~/src/gcc_source state=directory
    - stat: path=~/src/gcc_source/gcc-5.1.0.tar.gz
      register: p
    - get_url:
        dest: ~/src/gcc_source
        url: http://mirrors.concertpass.com/gcc/releases/gcc-5.1.0/gcc-5.1.0.tar.gz
      when: not p.stat.exists

    - stat: path=~/src/gcc_source/gcc-5.1.0
      register: p
    - unarchive: copy=no src=~/src/gcc_source/gcc-5.1.0.tar.gz dest=~/src/gcc_source/
      when: not p.stat.exists
    - command: contrib/download_prerequisites
      args:
        chdir: ~/src/gcc_source/gcc-5.1.0
        creates: ~/src/gcc_source/gcc-5.1.0/isl-0.14


    - file: path=~/src/gcc_build state=directory
    - command: ~/src/gcc_source/gcc-5.1.0/configure --prefix=$HOME/local --enable-host-shared --enable-languages=c,c++,fortran
      args:
        chdir: ~/src/gcc_build
        creates: ~/src/gcc_build/Makefile
    - command: make -j
      args:
        chdir: ~/src/gcc_build
        #############################################
        #creates: ~/src/gcc_build/gcc
        #############################################
    - command: make install
      args:
        chdir: ~/src/gcc_build



- hosts: julia_buildslaves
  vars_files:
    - secret/vars.yml
  sudo: yes
  pre_tasks:
    # Save home directory to "home" envvar
    - shell: echo ~
      sudo: no
      register: home

  roles:
    # You've gotta be first, la!
    - role: server

    - role: julia_buildslave

    # Also add startup role to run biliserver/server.py
    - role: startup_script
      service_name: buildslave
      daemon: /usr/bin/python
      daemon_opts: "{{home.stdout}}/buildbot/sandbox/bin/buildslave start --nodaemon"
