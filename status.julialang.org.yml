---
- hosts: status.julialang.org
  vars_files:
    - secret/vars.yml
  pre_tasks:
    # Save out our home directory
    - shell: echo ~
      register: home
      sudo: no

    - name: Make sure packages are installed
      apt: name={{ item }} state=latest
      with_items:
        - git
        - python-django
        - uwsgi
      sudo: yes

    # Also clone git repository to get cache server code, and setup tornado to serve at startup
    - name: Checkout status.julialang.org source to ~/status.julialang.org
      git: repo=https://github.com/staticfloat/status.julialang.org.git
           dest=~/status.julialang.org

    - name: Install uwsgi configuration
      template: src=templates/status.julialang.org.ini dest=/etc/uwsgi/apps-enabled/status.julialang.org.ini
      sudo: yes

    - service: name=uwsgi state=restarted
      sudo: yes

  roles:
    - role: server
      server_hostname: status

    - role: nginx
      sudo: yes
      # Install SSL certificates
      nginx_ssl_files:
        status.julialang.org:
          key: "~/etc/secure/ssl/status.julialang.org.key"
          certs:
            - "~/etc/secure/ssl/status.julialang.org.crt"
            - "~/etc/secure/ssl/startssl.chain.crt"
      nginx_sites:
        # Create HTTP -> HTTPS redirection metaserver
        ssl_redirect:
          - listen 80
          - server_name status.julialang.org *.status.julialang.org
          - return 301 https://$http_host$request_uri

        # Actual cache.julialang.org website configuration
        cache.julialang.org:
          - listen 443 ssl
          - server_name         status.julialang.org
          - ssl_certificate     ssl/status.julialang.org.crt
          - ssl_certificate_key ssl/status.julialang.org.key
          - ssl_protocols       TLSv1 TLSv1.1 TLSv1.2

          - location = / {
              rewrite ^$ /index.html break;
            }

          - "location = /index.html {
              alias {{home.stdout}}/status.julialang.org/www/dashboard_project/dashboard_project/sitestatic/html/index.html;
            }"
          - location = /install-julia.sh {
              alias {{home.stdout}}status.julialang.org/www/dashboard_project/dashboard_project/sitestatic/install-julia.sh;
            }
          - location = /install-julia.sh.sha256 {
              alias {{home.stdout}}/status.julialang.org/www/dashboard_project/dashboard_project/sitestatic/install-julia.sh.sha256;
            }

          - location /static/ {
              alias {{home.stdout}}/status.julialang.org/www/dashboard_project/dashboard_project/sitestatic/;
              expires 30d;
            }

          - location /media/ {
              alias {{home.stdout}}/status.julialang.org/www/dashboard_project/dashboard_project/sitestatic/;
              expires 30d;
            }

          - location / {
              include uwsgi_params;
              uwsgi_pass unix:/tmp/status.julialang.org.socket;
            }
